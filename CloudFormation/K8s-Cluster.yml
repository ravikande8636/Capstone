Description: >
    Ravi k
    This template deploys EKS Cluster with Worker nodes and IAM roles as needed.

Parameters:
    EnvironmentName:
        Description: An environment name that will be prefixed to resource names
        Type: String
    
    EKSClusterName:
        Description: EKS Cluster Name
        Type: String 
    
    K8sVersion:
        Description: Kubernetes Version
        Type: String 
    
Resources:
  eksClusterRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - eks.amazonaws.com
          Action:
          - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
  
  ControlplaneSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow http to our load balancer
      VpcId:
        Fn::ImportValue:
          !Sub "VPCID-${EnvironmentName}"
    
  myCluster:
    Type: 'AWS::EKS::Cluster'
    Properties:
      Name: !Ref EKSClusterName
      Version: !Ref K8sVersion
      RoleArn: 
       Fn::GetAtt:
        - Arn
      ResourcesVpcConfig:
        SecurityGroupIds:
          - sg-6979fe18
        SubnetIds:
          - Fn::ImportValue: !Sub "PUB1-SN-${EnvironmentName}"
          - Fn::ImportValue: !Sub "PUB2-SN-${EnvironmentName}"